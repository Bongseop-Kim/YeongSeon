# ADR 0001: 읽기 = View, 쓰기 = RPC

상태: 승인됨
일자: 2026-02-02

## 배경

프로젝트에서 DB 뷰와 클라이언트 쿼리 빌더 호출로 표현 가능한 데이터 형태에 읽기 RPC 사용이 늘어나고 있었다. 이로 인해 중복과 API 표면 복잡도가 증가했다.

동시에 쓰기 경로(주문 생성, 장바구니 교체)는 트랜잭션 무결성과 소유권 검증이 필요하여 순수 클라이언트 테이블 쓰기로는 적합하지 않았다.

## 결정

다음 아키텍처 규칙을 채택한다:

- **읽기 경로**: DB View + API 레이어에서 `from().select()` 사용.
- **쓰기 경로**: Edge Function 진입점 + 트랜잭션 영속화를 위한 쓰기 RPC.

추가 제약:

1. UI와 DTO는 분리 유지 (Option B).
2. 매핑은 API mapper 파일에서만 수행.
3. 뷰 + 쿼리 빌더로 충분한 경우 읽기 RPC 사용 금지.
4. 쓰기 RPC는 명시적 보안 모드와 소유권 검증을 선언해야 한다.

## 결과

긍정적:

- 읽기 사용 사례에 대한 RPC 표면 축소.
- 뷰를 통한 읽기 모델 탐색성 향상.
- 기능별 API 레이어와 매퍼 경계 명확화.

트레이드오프:

- 설계상 두 가지 패턴이 공존 (읽기는 View, 쓰기는 RPC).
- 코드 리뷰에서 클라이언트의 직접 쓰기 RPC 사용을 방지하는 규율 필요.

## 적용된 변경 사항

- 상품 읽기를 `product_list_view`로 전환.
- 주문 읽기를 `order_list_view` + `order_item_view`로 전환.
- `get_products`, `get_product_by_id`, `get_products_by_ids` 읽기 RPC의 클라이언트 사용 제거.
- `get_orders`, `get_order` 읽기 RPC의 클라이언트 사용 제거.

## 비목표

- 쓰기 RPC 내부의 즉시 재작성.
- 기존 쓰기 RPC에 대한 즉시 권한 모델 개편.

## 후속 작업

1. 쓰기 RPC 실행 경계 강화 (엄격한 Edge 전용 계약이 필요한 경우).
2. 금액 최종 확정을 RPC로 완전 이전 및/또는 RPC에서 합계 검증.
3. 더 이상 참조되지 않는 레거시 읽기 객체 제거 (`get_orders`, `get_order`, 레거시 `order_items_view`).
